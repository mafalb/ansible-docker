# vi: set ft=yaml ts=2:
---

- hosts: localhost
  vars:
    - docker_assume_already_installed: true
  roles:
    - role: mafalb.docker/daemon
    - role: mafalb.docker/ansible
  tasks:

    - name: check LICENSE file
      include_role:
        name: mafalb.docker/tests
        tasks_from: license

    - name: check README file
      include_role:
        name: mafalb.docker/tests
        tasks_from: readme

    - name: check that container runs are idempotent
      include_role:
        name: mafalb.docker/tests
        tasks_from: run_container

    - name: get version of docker clientx
      check_mode: false
      changed_when: false
      command: docker version -f {% raw %} "{{ .Client.Version }}" {% endraw %}
      register: _docker_version

    - name: create docker container
      docker_container:
        name: xenial
        image: ubuntu:xenial
        tty: true

    - name: add xenial to inventory
      changed_when: false
      add_host:
        name: xenial
        ansible_connection: docker
        ansible_python_interpreter: python3
        ansible_become: false

    - name: get version of docker daemon
      check_mode: false
      changed_when: false
      command: docker version -f {% raw %} "{{ .Server.Version }}" {% endraw %}
      register: _dockerd_version

    - debug: var=_docker_version
      tags:
        - never
        - debug

    - debug: var=_dockerd_version
      tags:
        - never
        - debug

    - name: assert that docker and dockerd versions match
      assert:
        that:
          - _docker_version.stdout == _dockerd_version.stdout

    - package_facts:

    - debug: var=docker.assume_already_installed
      tags:
        - never
        - debug
    - assert:
        that:
        - docker.assume_already_installed
        - ansible_facts.packages['docker-ce'] is defined
      when:
      - ansible_env.TRAVIS

- hosts: xenial
  gather_facts: false
  tasks:
    - name: install python3
      raw: apt-get install -y python3

- hosts: xenial
  roles:
    - role: mafalb.docker
      docker_package: docker-ce
  tasks:
    - name: check docker-ce on ubuntu xenial
      include_role:
        name: mafalb.docker/tests
        tasks_from: xenial-docker-ce

