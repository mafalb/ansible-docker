# vi: set ft=yaml ts=2:
---

- hosts: cihost
  vars:
    - docker_assume_already_installed: true
  roles:
    - role: mafalb.docker/daemon
    - role: mafalb.docker/ansible
    - role: mafalb.docker/tests
  tasks:

    - name: check LICENSE file
      include_role:
        name: mafalb.docker/tests
        tasks_from: license

    - name: check README file
      include_role:
        name: mafalb.docker/tests
        tasks_from: readme

    - name: check that container runs are idempotent
      include_role:
        name: mafalb.docker/tests
        tasks_from: run_container

- name: create a ubuntu xenial container
  hosts: cihost
  roles:
    - role: mafalb.ansible_ci/node/docker
      container_name: xenial
      volumes:
        - /sys/fs/cgroup:/sys/fs/cgroup:ro
      image_name: centos_image1
      src: ubuntu-16

- hosts: xenial
  gather_facts: false
  pre_tasks:
    - name: apt-get update
      changed_when: false
      raw: apt-get update
    - name: install python3
      changed_when: false
      raw: apt-get install -y python3-apt apt-transport-https

- hosts: xenial
  gather_facts: true
  roles:
    - role: mafalb.docker/daemon
      docker_package: docker-ce
  tasks:
    - name: check docker-ce on ubuntu xenial
      include_role:
        name: mafalb.docker/tests
        tasks_from: xenial-docker-ce
    - name: assertions
      assert:
        that:
        - docker.assume_already_installed
        - ansible_facts.packages['docker-ce'] is defined
      when:
      - ansible_env.TRAVIS
